

# 測試部屬
1-1. 向 vcs 取得專案 、環境的下一個版本號 
    version/next?projectName=tkbgoapi&env=dev
1-2. 版本號保存到 db ,狀態修改成 0 deploying 
    deploy/deploying

2. 流程都跑完成功後 , 如何將這兩個API 結合 
    /deploy/success
    
    /version/upgrade

    upgradeAndGenerateNote
        syncFromGitlab
        getMergedMrsBetween
        MR 產生 Release Note
        存 project_versions
        stampVersionForMrs
        
# 正式




DEV 發版 (upgradeAndGenerateNote dev)
    1. 查出上一個 state=SUCCESS 的 dev 版本 ➜ lastVersion
    2. 比對 newVersion > lastVersion.version
    3. startTime = lastVersion.createdTime 或 now - 1 month
    4. syncFromGitlab(projectName)
    5. getMergedMrsBetween(projectName, "develop", "dev", startTime, now)
    6. 用這些 MR 產生 Release Note
    7. 存 project_versions (env=dev, version=newVersion, state=SUCCESS, releaseNote)
    8. stampVersionForMrs(projectName, "dev", mrIds, newVersion) → version_dev=newVersion, released_dev=TRUE

PROD 發版 (upgradeAndGenerateNote prod)
    1. 只把 projectEnv="prod" 傳進來
    2. 查 last prod version（或你要怎麼定義都行）
    3. 查 MR：getMergedMrsBetween(projectName, "develop", "prod", ...)→ 已釋出 dev、未釋出 prod
    4. 產生 Release Note
    5. 存 project_versions (env=prod, version=newVersion)
    6. stampVersionForMrs(projectName, "prod", mrIds, newVersion) → version_prod=newVersion, released_prod=TRUE
    
Rollback dev / prod
    1. rollbackVersion(projectName, env, version)
    2. project_versions.state = ROLLED_BACK
    3. unstampVersionForMrs(projectName, env, version)
        dev：清 version_dev + released_dev
        prod：清 version_prod + released_prod